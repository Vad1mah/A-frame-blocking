<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost in the Fog — Сцена 1 (блокинг)</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe-master.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0B0B0D; overflow: hidden; }
    </style>
</head>
<body>
    <a-scene
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; shadowMapType: pcfsoft"
        shadow="type: pcfsoft"
        fog="type: exponential; color: #2F3E46; density: 0.12"
        vr-mode-ui="enabled: true">

        <!-- Небо (глубокая ночь) -->
        <a-sky color="#1B263B"></a-sky>
        <!-- Луна: не подвержена туману + мягкий ореол -->
        <a-entity id="moon" position="-60 90 -140">
            <a-sphere radius="8" color="#dfe8ff" emissive="#dfe8ff" emissive-intensity="0.85" material="shader: flat; transparent: true; opacity: 0.95; fog: false"></a-sphere>
            <a-sphere radius="12" color="#dfe8ff" material="shader: flat; transparent: true; opacity: 0.08; fog: false"></a-sphere>
            <a-entity id="moon-light" light="type: directional; color: #aebcff; intensity: 0.42; castShadow: true; shadowCameraTop: 130; shadowCameraBottom: -130; shadowCameraLeft: -130; shadowCameraRight: 130; shadowCameraFar: 400; shadowMapWidth: 2048; shadowMapHeight: 2048; shadowBias: -0.0003; target: #shadow-target" position="-60 90 -140"></a-entity>
        </a-entity>
        <a-entity id="shadow-target" position="0 0 -30"></a-entity>

        <!-- Свет: приглушённый общий; лунный directional даёт основные тени -->
        <a-entity light="type: ambient; color: #444; intensity: 0.18"></a-entity>

        <!-- Земля: большая область для перемещения -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200" color="#0B0B0D" shadow="receive: true"></a-plane>

        <!-- Простой ориентир-дорожка -->
        <a-plane position="0 0.01 -10" rotation="-90 0 0" width="10" height="80" color="#1B263B" opacity="0.6"></a-plane>

        <!-- Крупная хижина (примитивы, минимальная детализация) -->
        <a-box position="0 4 -30" width="14" height="8" depth="10" color="#6B7280" shadow="cast: true; receive: true"></a-box>
        <!-- Крыша: конус, поднят выше, чтобы не пересекаться со стенами -->
        <a-cone position="0 11 -30" radius-bottom="8" radius-top="0.2" height="5.5" color="#1C2A1F" shadow="cast: true"></a-cone>
		<!-- Дверь и окна на фасаде (передняя грань к игроку, вынесены вперёд) -->
		<a-box position="0 2 -24.95" width="2.4" height="3.8" depth="0.3" color="#0B0B0D" shadow="cast: true"></a-box>
		<a-sphere position="1.0 2 -24.9" radius="0.09" color="#6B7280"></a-sphere>
		<a-box position="-4.8 4 -24.97" width="2.2" height="1.6" depth="0.06" color="#1B263B" emissive="#1B263B" emissive-intensity="0.6"></a-box>
		<a-box position="4.8 4 -24.97" width="2.2" height="1.6" depth="0.06" color="#1B263B" emissive="#1B263B" emissive-intensity="0.6"></a-box>
		<!-- Примитивный фонарь у двери: крепёж + светящийся шар + источник света (передняя грань) -->
		<a-entity id="door-lamp" position="1.2 4.6 -24.9" flicker-light="min: 0.5; max: 2.4; speed: 2.0">
			<!-- Кронштейн (брусок вдоль Z) -->
			<a-box position="0 0 0.11" width="0.06" height="0.06" depth="0.22" color="#1a1a1a"></a-box>
			<!-- Корпус лампы -->
			<a-cone position="0 0.10 0.28" radius-bottom="0.14" radius-top="0.05" height="0.22" color="#202020" shadow="cast: true"></a-cone>
			<!-- Стекло -->
			<a-cylinder position="0 -0.02 0.28" radius="0.11" height="0.18" material="color: #B9A13A; transparent: true; opacity: 0.18"></a-cylinder>
			<!-- Лампочка -->
			<a-sphere class="lamp-bulb" position="0 -0.02 0.28" radius="0.07" color="#B9A13A" emissive="#B9A13A" emissive-intensity="0.8"></a-sphere>
			<!-- Источник света -->
			<a-entity class="lamp-light" position="0 -0.02 0.28" light="type: point; color: #B9A13A; intensity: 1.5; distance: 10; decay: 2; castShadow: true"></a-entity>
		</a-entity>

        <!-- Большие деревья по периметру (простые ствол + крона) -->
        <!-- 1 -->
        <a-cylinder position="-30 9 -40" radius="0.8" height="18" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="-30 18.5 -40" radius="5.5" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 2 -->
        <a-cylinder position="-10 9 -35" radius="0.9" height="18" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="-10 18.5 -35" radius="6" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 3 -->
        <a-cylinder position="15 10 -38" radius="0.9" height="20" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="15 20 -38" radius="6.2" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 4 -->
        <a-cylinder position="35 10 -25" radius="0.8" height="20" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="35 20 -25" radius="5.8" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 5 -->
        <a-cylinder position="45 9 -10" radius="0.7" height="18" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="45 18.5 -10" radius="5.2" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 6 -->
        <a-cylinder position="-45 9 -10" radius="0.7" height="18" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="-45 18.5 -10" radius="5.2" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 7 -->
        <a-cylinder position="-25 9 30" radius="0.8" height="18" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="-25 18.5 30" radius="5.5" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 8 -->
        <a-cylinder position="0 10 40" radius="0.9" height="20" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="0 20 40" radius="6" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 9 -->
        <a-cylinder position="30 10 35" radius="0.8" height="20" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="30 20 35" radius="5.8" color="#1C2A1F" shadow="cast: true"></a-sphere>
        <!-- 10 -->
        <a-cylinder position="-40 10 5" radius="0.9" height="20" color="#2d2622" shadow="cast: true"></a-cylinder>
        <a-sphere position="-40 20 5" radius="6.2" color="#1C2A1F" shadow="cast: true"></a-sphere>

		<!-- Равномерное окружение деревьев/кустов/камней добавляется ниже скриптом -->
		<a-entity id="world-decor" scatter-forest="area: 180; trees: 560; bushes: 400; rocks: 220; excludeRadius: 18; walkwayX: 5; walkwayZStart: -50; walkwayZEnd: 30; minTreeSpacing: 7; minBushSpacing: 2.4; minRockSpacing: 2.0"></a-entity>

        <!-- Игрок/камера: простое управление взглядом и WASD -->
        <a-entity id="player" position="0 1.6 28">
            <a-camera look-controls="pointerLockEnabled: true" wasd-controls="acceleration: 30">
                <a-cursor color="#ffffff" opacity="0.6"></a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>

	<script>
		(function() {
			if (typeof AFRAME === 'undefined') { return; }

			AFRAME.registerComponent('scatter-forest', {
				schema: {
					area: { type: 'number', default: 180 },
					trees: { type: 'int', default: 560 },
					bushes: { type: 'int', default: 400 },
					rocks: { type: 'int', default: 220 },
					excludeRadius: { type: 'number', default: 18 },
					walkwayX: { type: 'number', default: 5 },
					walkwayZStart: { type: 'number', default: -50 },
					walkwayZEnd: { type: 'number', default: 30 },
					minTreeSpacing: { type: 'number', default: 7 },
					minBushSpacing: { type: 'number', default: 2.4 },
					minRockSpacing: { type: 'number', default: 2.0 }
				},
				init: function () {
					const sceneEl = this.el.sceneEl;
					const config = this.data;
					const half = config.area / 2;
					const houseCenter = { x: 0, z: -30 };

					function randomInRange(min, max) { return Math.random() * (max - min) + min; }
					function isExcluded(x, z) {
						const dx = x - houseCenter.x;
						const dz = z - houseCenter.z;
						const dist = Math.sqrt(dx * dx + dz * dz);
						if (dist < config.excludeRadius) return true;
						if (x > -config.walkwayX && x < config.walkwayX && z > config.walkwayZStart && z < config.walkwayZEnd) return true;
						return false;
					}

					function createTree(positionX, positionZ) {
						const trunkHeight = randomInRange(11, 19);
						const trunk = document.createElement('a-cylinder');
						trunk.setAttribute('position', `${positionX} ${trunkHeight / 2} ${positionZ}`);
						trunk.setAttribute('radius', randomInRange(0.30, 0.6));
						trunk.setAttribute('height', trunkHeight);
						trunk.setAttribute('color', '#2d2622');
						trunk.setAttribute('shadow', 'cast: true');

						const crown = document.createElement('a-sphere');
						const crownRadius = randomInRange(2.2, 4.0);
						crown.setAttribute('position', `${positionX} ${trunkHeight + crownRadius * 0.9} ${positionZ}`);
						crown.setAttribute('radius', crownRadius);
						crown.setAttribute('scale', `${randomInRange(1.0, 1.2)} ${randomInRange(0.8, 1.0)} ${randomInRange(1.0, 1.2)}`);
						crown.setAttribute('color', '#1C2A1F');
						crown.setAttribute('shadow', 'cast: true');

						sceneEl.appendChild(trunk);
						sceneEl.appendChild(crown);
					}

					function createBushCluster(positionX, positionZ) {
						const cluster = document.createElement('a-entity');
						cluster.setAttribute('position', `${positionX} 0 ${positionZ}`);
						// Несколько перекрывающихся сфер для визуально отличного куста
						const blobCount = Math.floor(randomInRange(2, 5));
						for (let i = 0; i < blobCount; i++) {
							const blob = document.createElement('a-sphere');
							const r = randomInRange(0.5, 1.2);
							const ox = randomInRange(-0.6, 0.6);
							const oz = randomInRange(-0.6, 0.6);
							blob.setAttribute('position', `${ox} ${r * 0.7} ${oz}`);
							blob.setAttribute('radius', r);
							blob.setAttribute('scale', `${randomInRange(1.0, 1.4)} ${randomInRange(0.6, 0.9)} ${randomInRange(1.0, 1.4)}`);
							blob.setAttribute('color', '#1A2A1A');
							blob.setAttribute('shadow', 'cast: true');
							cluster.appendChild(blob);
						}
						sceneEl.appendChild(cluster);
					}

					function createRock(positionX, positionZ) {
						const rock = document.createElement('a-sphere');
						const r = randomInRange(0.35, 1.2);
						rock.setAttribute('position', `${positionX} ${r * 0.5} ${positionZ}`);
						rock.setAttribute('radius', r);
						// Сплюснутые формы, чтобы отличались от кустов
						rock.setAttribute('scale', `${randomInRange(1.2, 1.8)} ${randomInRange(0.5, 0.8)} ${randomInRange(1.0, 1.6)}`);
						rock.setAttribute('color', '#6B7280');
						rock.setAttribute('shadow', 'cast: true');
						sceneEl.appendChild(rock);
					}

					const placedPositions = { trees: [], bushes: [], rocks: [] };

					function isFarEnough(list, x, z, minDist) {
						for (let i = 0; i < list.length; i++) {
							const dx = list[i].x - x;
							const dz = list[i].z - z;
							if (dx * dx + dz * dz < minDist * minDist) return false;
						}
						return true;
					}

					function tryPlace(kind, count, creator, minSpacing) {
						let placed = 0, guard = 0, cap = count * 20;
						while (placed < count && guard < cap) {
							guard++;
							const x = randomInRange(-half, half);
							const z = randomInRange(-half, half);
							if (isExcluded(x, z)) continue;
							if (!isFarEnough(placedPositions[kind], x, z, minSpacing)) continue;
							creator(x, z);
							placedPositions[kind].push({ x, z });
							placed++;
						}
					}

					tryPlace('trees', config.trees, createTree, config.minTreeSpacing);
					tryPlace('bushes', config.bushes, createBushCluster, config.minBushSpacing);
					tryPlace('rocks', config.rocks, createRock, config.minRockSpacing);
				}
			});

			// Мерцание света (фонарь)
			AFRAME.registerComponent('flicker-light', {
				schema: { min: {type: 'number', default: 0.8}, max: {type: 'number', default: 1.8}, speed: {type: 'number', default: 1.0} },
				init: function () {
					this.t = Math.random() * Math.PI * 2;
					this.lightEl = this.el.querySelector('.lamp-light');
					this.bulbEl = this.el.querySelector('.lamp-bulb');
				},
				tick: function (time, dt) {
					if (!this.lightEl) return;
					this.t += (dt / 1000) * this.data.speed;
					const noise = (Math.sin(this.t * 2.3) + Math.sin(this.t * 1.7 + 1.3) + Math.sin(this.t * 3.1 + 2.1)) / 3;
					const k = (noise + 1) / 2; // 0..1
					const intensity = this.data.min + k * (this.data.max - this.data.min);
					this.lightEl.setAttribute('light', 'intensity', intensity);
					if (this.bulbEl) {
						const bulb = 0.5 + k * 1.2;
						this.bulbEl.setAttribute('emissive-intensity', bulb);
					}
				}
			});
		})();
	</script>
</body>
</html>


